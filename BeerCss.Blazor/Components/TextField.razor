@using Microsoft.AspNetCore.Components.Forms
@using System.Diagnostics.CodeAnalysis
@using BeerCss.Blazor.Common

@inherits Microsoft.AspNetCore.Components.Forms.InputText

@code {
    [Parameter]
    public bool Submit { get; set; }

    [Parameter]
    public bool Fill { get; set; }

    [Parameter]
    public bool Round { get; set; }

    [Parameter]
    public bool Border { get; set; }

    [Parameter]
    public Size Size { get; set; } = Size.Medium;

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public string? HelpText { get; set; }

    [Parameter]
    public bool InProgress { get; set; }

    [Parameter]
    public RenderFragment? Prefix { get; set; }

    [Parameter]
    public RenderFragment? Suffix { get; set; }

    [Parameter]
    public bool Disabled { get; set;}

    private CssBuilder RealCssClass => new CssBuilder()
        .AddClass("field ")
        .AddClass(CssClass)
        .AddClass("fill", Fill)
        .AddClass("round", Round)
        .AddClass("border", Border)
        .AddClass("prefix", Prefix is not null)
        .AddClass("suffix", Suffix is not null)
        .AddClass("label", Label is not null)
        .AddClass(Size.ToCssClass())
        .AddClassFromAttributes(AdditionalAttributes);

    private RenderFragment RenderInput() => (builder) => base.BuildRenderTree(builder);

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        if (this.Disabled && this.AdditionalAttributes is null)
        {
            this.AdditionalAttributes = new Dictionary<string, object> { { "disabled", "disabled" } };
        }
        else if (this.Disabled && this.AdditionalAttributes is not null && !this.AdditionalAttributes.ContainsKey("disabled"))
        {
            this.AdditionalAttributes = new Dictionary<string, object>(this.AdditionalAttributes!) { { "disabled", "disabled" } };
        }
        else if (!this.Disabled && this.AdditionalAttributes is not null && this.AdditionalAttributes.ContainsKey("disabled"))
        {
            var attributes = new Dictionary<string, object>(this.AdditionalAttributes!);
            attributes.Remove("disabled");
            this.AdditionalAttributes = attributes;
        }
    }
}

<div class="@RealCssClass">
    @if (InProgress)
    {
        <Progress Circle />
    }
    else if (Prefix is not null)
    {
        @Prefix
    }
    @RenderInput()
    @if (Label is not null)
    {
        <label>@Label</label>
    }
    @if (!(EditContext?.IsValid(this.FieldIdentifier) ?? true))
    {
        <span class="error">@EditContext.GetValidationMessages(this.FieldIdentifier).FirstOrDefault()</span>
    }
    else if (HelpText is not null)
    {
        <span class="helper">@HelpText</span>
    }
    @if (Suffix is not null)
    {
        @Suffix
    }
</div>